<div class="roles-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="title-section">
        <h1 class="page-title">
          <mat-icon>admin_panel_settings</mat-icon>
          Roles Management
        </h1>
        <p class="page-subtitle">
          Manage system roles and permissions
        </p>
      </div>

      <div class="header-actions">
        <button mat-raised-button
                color="primary"
                (click)="openCreateRoleDialog()"
                class="create-button">
          <mat-icon>add</mat-icon>
          Create Role
        </button>
      </div>
    </div>
  </div>

  <!-- Roles Table -->
  <mat-card class="table-card">
    <mat-card-content>
      @if (loading()) {
        <div class="loading-state">
          <mat-icon class="loading-icon">refresh</mat-icon>
          <p>Loading roles...</p>
        </div>
      } @else if (!loading() && roles().length === 0) {
        <div class="empty-state">
          <mat-icon>admin_panel_settings</mat-icon>
          <h3>No Roles Found</h3>
          <p>Create your first role to get started with user management.</p>
          <button mat-raised-button
                  color="primary"
                  (click)="openCreateRoleDialog()">
            <mat-icon>add</mat-icon>
            Create Role
          </button>
        </div>
      } @else {
        <div class="grid-container">
          <app-data-grid
            [data]="roles()"
            [columns]="gridColumns"
            [actions]="gridActions"
            [config]="gridConfig"
            [loading]="loading()">

            <!-- Custom Toolbar -->
            <ng-template #toolbar>
              <div class="grid-toolbar-content">
                <div class="toolbar-left">
                  <h3>Roller ({{ roles().length }})</h3>
                </div>
                <div class="toolbar-right">
                  <button mat-icon-button
                          matTooltip="Yenile"
                          (click)="loadRoles()">
                    <mat-icon>refresh</mat-icon>
                  </button>
                </div>
              </div>
            </ng-template>
          </app-data-grid>
        </div>
      }
    </mat-card-content>
  </mat-card>
</div>


<!-- Create/Edit Role Dialog -->
@if (showRoleDialog()) {
  <div class="dialog-overlay" (click)="closeRoleDialog()">
    <div class="dialog-container" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>{{ editingRole() ? 'Edit Role' : 'Create New Role' }}</h2>
        <button mat-icon-button (click)="closeRoleDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <form [formGroup]="roleForm" (ngSubmit)="saveRole()" class="dialog-form">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Role Name</mat-label>
          <input matInput formControlName="name" placeholder="Enter role name">
          <mat-error *ngIf="roleForm.get('name')?.hasError('required')">
            Role name is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Description</mat-label>
          <textarea matInput
                    formControlName="description"
                    placeholder="Enter role description"
                    rows="3"></textarea>
        </mat-form-field>

        <div class="dialog-actions">
          <button type="button"
                  mat-button
                  (click)="closeRoleDialog()">
            Cancel
          </button>
          <button type="submit"
                  mat-raised-button
                  color="primary"
                  [disabled]="roleForm.invalid || saving()">
            @if (saving()) {
              <mat-icon class="loading-icon">refresh</mat-icon>
            } @else {
              <mat-icon>{{ editingRole() ? 'save' : 'add' }}</mat-icon>
            }
            {{ editingRole() ? 'Update' : 'Create' }} Role
          </button>
        </div>
      </form>
    </div>
  </div>
}

<!-- Permissions Management Dialog -->
@if (showPermissionsDialog()) {
  <div class="dialog-overlay" (click)="closePermissionsDialog()">
    <div class="dialog-container permissions-dialog" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Manage Permissions - {{ selectedRole()?.name }}</h2>
        <button mat-icon-button (click)="closePermissionsDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="permissions-content">
        @if (loadingPermissions()) {
          <div class="loading-state">
            <mat-icon class="loading-icon">refresh</mat-icon>
            <p>Loading permissions...</p>
          </div>
        } @else {
          <mat-tab-group>
            <mat-tab label="Assign Permissions">
              <div class="tab-content">
                @for (category of permissionCategories(); track category) {
                  <mat-expansion-panel class="category-panel">
                    <mat-expansion-panel-header>
                      <mat-panel-title>
                        <mat-icon>folder</mat-icon>
                        {{ category }}
                      </mat-panel-title>
                      <mat-panel-description>
                        {{ getCategoryPermissions(category).length }} permissions
                      </mat-panel-description>
                    </mat-expansion-panel-header>

                    <div class="permissions-list">
                      @for (permission of getCategoryPermissions(category); track permission.id) {
                        <mat-checkbox
                          [checked]="isPermissionAssigned(permission.id)"
                          (change)="togglePermission(permission.id, $event.checked)"
                          class="permission-checkbox">
                          <div class="permission-info">
                            <div class="permission-name">{{ permission.name }}</div>
                            <div class="permission-description">{{ permission.description }}</div>
                          </div>
                        </mat-checkbox>
                      }
                    </div>
                  </mat-expansion-panel>
                }
              </div>
            </mat-tab>

            <mat-tab label="Current Permissions">
              <div class="tab-content">
                @if (rolePermissions().length === 0) {
                  <div class="empty-permissions">
                    <mat-icon>security</mat-icon>
                    <p>No permissions assigned to this role</p>
                  </div>
                } @else {
                  <mat-chip-set class="permissions-chips">
                    @for (permission of rolePermissions(); track permission.id) {
                      <mat-chip [removable]="true" (removed)="removePermission(permission.id)">
                        {{ permission.name }}
                        <mat-icon matChipRemove>cancel</mat-icon>
                      </mat-chip>
                    }
                  </mat-chip-set>
                }
              </div>
            </mat-tab>
          </mat-tab-group>

          <div class="dialog-actions">
            <button type="button"
                    mat-button
                    (click)="closePermissionsDialog()">
              Close
            </button>
            <button type="button"
                    mat-raised-button
                    color="primary"
                    (click)="savePermissions()"
                    [disabled]="savingPermissions()">
              @if (savingPermissions()) {
                <mat-icon class="loading-icon">refresh</mat-icon>
              } @else {
                <mat-icon>save</mat-icon>
              }
              Save Changes
            </button>
          </div>
        }
      </div>
    </div>
  </div>
}